---
title: Using cmdstanr in SimDesign
author: marklai
date: '2021-07-14'
slug: using-cmdstanr-in-simdesign
output:
  blogdown::html_page:
    toc: true
categories:
  - Programming
  - Statistics
tags:
  - Bayesian
  - Simulation
subtitle: ''
summary: ''
authors: []
lastmod: '2021-07-16T20:42:00-07:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---



<pre class="r"><code>library(SimDesign)
library(cmdstanr)</code></pre>
<p>[Update: Use parallel computing with two cores.]</p>
<p>Adapted from <a href="https://cran.r-project.org/web/packages/SimDesign/vignettes/SimDesign-intro.html" class="uri">https://cran.r-project.org/web/packages/SimDesign/vignettes/SimDesign-intro.html</a></p>
<p>See <a href="https://mc-stan.org/cmdstanr/articles/cmdstanr.html" class="uri">https://mc-stan.org/cmdstanr/articles/cmdstanr.html</a> for using <code>cmdstanr</code></p>
<pre class="r"><code>Design &lt;- createDesign(sample_size = c(30, 60, 120, 240), 
                       distribution = c(&#39;norm&#39;, &#39;chi&#39;))
Design</code></pre>
<pre><code>## # A tibble: 8 Ã— 2
##   sample_size distribution
##         &lt;dbl&gt; &lt;chr&gt;       
## 1          30 norm        
## 2          60 norm        
## 3         120 norm        
## 4         240 norm        
## 5          30 chi         
## 6          60 chi         
## 7         120 chi         
## 8         240 chi</code></pre>
<pre class="r"><code>Generate &lt;- function(condition, fixed_objects = NULL) {
    N &lt;- condition$sample_size
    dist &lt;- condition$distribution
    if(dist == &#39;norm&#39;){
        dat &lt;- rnorm(N, mean = 3)
    } else if(dist == &#39;chi&#39;){
        dat &lt;- rchisq(N, df = 3)
    }
    dat
}</code></pre>
<p>Define Bayes estimator of the mean with STAN</p>
<pre class="r"><code># STAN model
bmean_stan &lt;- &quot;
    data {
        int&lt;lower=0&gt; N;
        real x[N];
    }
    parameters {
        real mu;
        real&lt;lower=0&gt; sigma;
    }
    model {
        target += normal_lpdf(mu | 0, 10);  // weakly informative prior
        target += normal_lpdf(x | mu, sigma);
    }
&quot;
# Save file
stan_path &lt;- write_stan_file(bmean_stan)
mod &lt;- cmdstan_model(stan_path)</code></pre>
<pre><code>## Warning in &#39;/tmp/RtmpVU5PBw/model-7f13b1ada25b1.stan&#39;, line 4, column 8: Declaration
##     of arrays by placing brackets after a variable name is deprecated and
##     will be removed in Stan 2.32.0. Instead use the array keyword before the
##     type. This can be changed automatically using the auto-format flag to
##     stanc</code></pre>
<pre class="r"><code>Analyse &lt;- function(condition, dat, fixed_objects = NULL) {
    mod &lt;- fixed_objects$mod
    M0 &lt;- mean(dat)
    M1 &lt;- mean(dat, trim = .1)
    M2 &lt;- mean(dat, trim = .2)
    med &lt;- median(dat)
    stan_fit &lt;- quiet(mod$sample(list(x = dat, N = length(dat)),
                                 refresh = 0, chains = 1, 
                                 show_messages = FALSE))
    MB &lt;- stan_fit$summary(&quot;mu&quot;, mean)$mean[1]
    ret &lt;- c(mean_no_trim = M0, mean_trim.1 = M1, 
             mean_trim.2 = M2, median = med, 
             bayes_mean = MB)
    ret
}</code></pre>
<pre class="r"><code>Summarise &lt;- function(condition, results, fixed_objects = NULL) {
    obs_bias &lt;- bias(results, parameter = 3)
    obs_RMSE &lt;- RMSE(results, parameter = 3)
    ret &lt;- c(bias = obs_bias, RMSE = obs_RMSE, RE = RE(obs_RMSE))
    ret
}</code></pre>
<pre class="r"><code>res &lt;- runSimulation(Design, replications = 50, generate = Generate, 
                     analyse = Analyse, summarise = Summarise, 
                     parallel = TRUE,
                     ncores = min(2, parallel::detectCores()), 
                     fixed_objects = list(mod = mod),
                     packages = &quot;cmdstanr&quot;)</code></pre>
<pre><code>## 
## Number of parallel clusters in use: 2</code></pre>
<pre><code>## 
## 
Design row: 1/8;   Started: Sun Jul 31 00:06:14 2022;   Total elapsed time: 0.00s 
## 
## 
Design row: 2/8;   Started: Sun Jul 31 00:06:21 2022;   Total elapsed time: 6.80s 
## 
## 
Design row: 3/8;   Started: Sun Jul 31 00:06:27 2022;   Total elapsed time: 12.65s 
## 
## 
Design row: 4/8;   Started: Sun Jul 31 00:06:34 2022;   Total elapsed time: 19.65s 
## 
## 
Design row: 5/8;   Started: Sun Jul 31 00:06:39 2022;   Total elapsed time: 25.48s 
## 
## 
Design row: 6/8;   Started: Sun Jul 31 00:06:45 2022;   Total elapsed time: 31.54s 
## 
## 
Design row: 7/8;   Started: Sun Jul 31 00:06:52 2022;   Total elapsed time: 38.26s 
## 
## 
Design row: 8/8;   Started: Sun Jul 31 00:06:59 2022;   Total elapsed time: 44.83s</code></pre>
<pre><code>## 
## Simulation complete. Total execution time: 50.90s</code></pre>
<pre class="r"><code>knitr::kable(res)</code></pre>
<table>
<colgroup>
<col width="3%" />
<col width="4%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="3%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="3%" />
<col width="5%" />
<col width="5%" />
<col width="4%" />
<col width="4%" />
<col width="3%" />
<col width="4%" />
<col width="4%" />
<col width="2%" />
<col width="7%" />
<col width="3%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">sample_size</th>
<th align="left">distribution</th>
<th align="right">bias.mean_no_trim</th>
<th align="right">bias.mean_trim.1</th>
<th align="right">bias.mean_trim.2</th>
<th align="right">bias.median</th>
<th align="right">bias.bayes_mean</th>
<th align="right">RMSE.mean_no_trim</th>
<th align="right">RMSE.mean_trim.1</th>
<th align="right">RMSE.mean_trim.2</th>
<th align="right">RMSE.median</th>
<th align="right">RMSE.bayes_mean</th>
<th align="right">RE.mean_no_trim</th>
<th align="right">RE.mean_trim.1</th>
<th align="right">RE.mean_trim.2</th>
<th align="right">RE.median</th>
<th align="right">RE.bayes_mean</th>
<th align="right">REPLICATIONS</th>
<th align="right">SIM_TIME</th>
<th align="left">COMPLETED</th>
<th align="right">SEED</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">30</td>
<td align="left">norm</td>
<td align="right">-0.0118190</td>
<td align="right">0.0014862</td>
<td align="right">0.0126367</td>
<td align="right">0.0417798</td>
<td align="right">-0.0124052</td>
<td align="right">0.1925357</td>
<td align="right">0.1962211</td>
<td align="right">0.1974239</td>
<td align="right">0.2340095</td>
<td align="right">0.1931643</td>
<td align="right">1</td>
<td align="right">1.038649</td>
<td align="right">1.051421</td>
<td align="right">1.477217</td>
<td align="right">1.0065399</td>
<td align="right">50</td>
<td align="right">6.802</td>
<td align="left">Sun Jul 31 00:06:21 2022</td>
<td align="right">919770021</td>
</tr>
<tr class="even">
<td align="right">60</td>
<td align="left">norm</td>
<td align="right">0.0138500</td>
<td align="right">0.0123798</td>
<td align="right">0.0159013</td>
<td align="right">0.0143448</td>
<td align="right">0.0137575</td>
<td align="right">0.1294069</td>
<td align="right">0.1322249</td>
<td align="right">0.1340543</td>
<td align="right">0.1620916</td>
<td align="right">0.1296239</td>
<td align="right">1</td>
<td align="right">1.044027</td>
<td align="right">1.073117</td>
<td align="right">1.568940</td>
<td align="right">1.0033577</td>
<td align="right">50</td>
<td align="right">5.844</td>
<td align="left">Sun Jul 31 00:06:27 2022</td>
<td align="right">1147125301</td>
</tr>
<tr class="odd">
<td align="right">120</td>
<td align="left">norm</td>
<td align="right">0.0248642</td>
<td align="right">0.0251620</td>
<td align="right">0.0262231</td>
<td align="right">0.0309249</td>
<td align="right">0.0243947</td>
<td align="right">0.0903066</td>
<td align="right">0.0925141</td>
<td align="right">0.0966194</td>
<td align="right">0.1155442</td>
<td align="right">0.0896688</td>
<td align="right">1</td>
<td align="right">1.049486</td>
<td align="right">1.144695</td>
<td align="right">1.637034</td>
<td align="right">0.9859249</td>
<td align="right">50</td>
<td align="right">7.003</td>
<td align="left">Sun Jul 31 00:06:34 2022</td>
<td align="right">165936352</td>
</tr>
<tr class="even">
<td align="right">240</td>
<td align="left">norm</td>
<td align="right">-0.0124981</td>
<td align="right">-0.0135860</td>
<td align="right">-0.0141574</td>
<td align="right">-0.0148045</td>
<td align="right">-0.0123418</td>
<td align="right">0.0681080</td>
<td align="right">0.0685800</td>
<td align="right">0.0715182</td>
<td align="right">0.0827685</td>
<td align="right">0.0688086</td>
<td align="right">1</td>
<td align="right">1.013908</td>
<td align="right">1.102646</td>
<td align="right">1.476840</td>
<td align="right">1.0206777</td>
<td align="right">50</td>
<td align="right">5.828</td>
<td align="left">Sun Jul 31 00:06:39 2022</td>
<td align="right">1169202745</td>
</tr>
<tr class="odd">
<td align="right">30</td>
<td align="left">chi</td>
<td align="right">0.0300504</td>
<td align="right">-0.2925417</td>
<td align="right">-0.4179901</td>
<td align="right">-0.4775784</td>
<td align="right">0.0219484</td>
<td align="right">0.4460887</td>
<td align="right">0.5256165</td>
<td align="right">0.6078532</td>
<td align="right">0.7030688</td>
<td align="right">0.4428674</td>
<td align="right">1</td>
<td align="right">1.388339</td>
<td align="right">1.856757</td>
<td align="right">2.484010</td>
<td align="right">0.9856100</td>
<td align="right">50</td>
<td align="right">6.064</td>
<td align="left">Sun Jul 31 00:06:45 2022</td>
<td align="right">666552130</td>
</tr>
<tr class="even">
<td align="right">60</td>
<td align="left">chi</td>
<td align="right">0.0302642</td>
<td align="right">-0.3434107</td>
<td align="right">-0.5061163</td>
<td align="right">-0.6635279</td>
<td align="right">0.0306421</td>
<td align="right">0.3189606</td>
<td align="right">0.4417358</td>
<td align="right">0.5724486</td>
<td align="right">0.7151231</td>
<td align="right">0.3217270</td>
<td align="right">1</td>
<td align="right">1.918011</td>
<td align="right">3.221060</td>
<td align="right">5.026751</td>
<td align="right">1.0174211</td>
<td align="right">50</td>
<td align="right">6.715</td>
<td align="left">Sun Jul 31 00:06:52 2022</td>
<td align="right">245891705</td>
</tr>
<tr class="odd">
<td align="right">120</td>
<td align="left">chi</td>
<td align="right">0.0297133</td>
<td align="right">-0.3006558</td>
<td align="right">-0.4464628</td>
<td align="right">-0.5809295</td>
<td align="right">0.0288748</td>
<td align="right">0.2420612</td>
<td align="right">0.3748495</td>
<td align="right">0.4983842</td>
<td align="right">0.6294695</td>
<td align="right">0.2401434</td>
<td align="right">1</td>
<td align="right">2.398079</td>
<td align="right">4.239144</td>
<td align="right">6.762371</td>
<td align="right">0.9842171</td>
<td align="right">50</td>
<td align="right">6.571</td>
<td align="left">Sun Jul 31 00:06:59 2022</td>
<td align="right">1719562701</td>
</tr>
<tr class="even">
<td align="right">240</td>
<td align="left">chi</td>
<td align="right">0.0170796</td>
<td align="right">-0.3419476</td>
<td align="right">-0.4842108</td>
<td align="right">-0.6231752</td>
<td align="right">0.0166940</td>
<td align="right">0.1400220</td>
<td align="right">0.3683362</td>
<td align="right">0.5032654</td>
<td align="right">0.6455598</td>
<td align="right">0.1398539</td>
<td align="right">1</td>
<td align="right">6.919842</td>
<td align="right">12.918189</td>
<td align="right">21.255941</td>
<td align="right">0.9976008</td>
<td align="right">50</td>
<td align="right">6.076</td>
<td align="left">Sun Jul 31 00:07:05 2022</td>
<td align="right">1548188555</td>
</tr>
</tbody>
</table>
