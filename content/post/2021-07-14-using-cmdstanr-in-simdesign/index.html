---
title: Using cmdstanr in SimDesign
author: marklai
date: '2021-07-14'
slug: using-cmdstanr-in-simdesign
categories:
  - Programming
  - Statistics
tags:
  - Bayesian
  - Simulation
subtitle: ''
summary: ''
authors: []
lastmod: '2021-07-16T20:42:00-07:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<pre class="r"><code>library(SimDesign)
library(cmdstanr)</code></pre>
<p>[Update: Use parallel computing with two cores.]</p>
<p>Adapted from <a href="https://cran.r-project.org/web/packages/SimDesign/vignettes/SimDesign-intro.html" class="uri">https://cran.r-project.org/web/packages/SimDesign/vignettes/SimDesign-intro.html</a></p>
<p>See <a href="https://mc-stan.org/cmdstanr/articles/cmdstanr.html" class="uri">https://mc-stan.org/cmdstanr/articles/cmdstanr.html</a> for using <code>cmdstanr</code></p>
<pre class="r"><code>Design &lt;- createDesign(sample_size = c(30, 60, 120, 240), 
                       distribution = c(&#39;norm&#39;, &#39;chi&#39;))
Design</code></pre>
<pre><code>## # A tibble: 8 x 2
##   sample_size distribution
##         &lt;dbl&gt; &lt;chr&gt;       
## 1          30 norm        
## 2          60 norm        
## 3         120 norm        
## 4         240 norm        
## 5          30 chi         
## 6          60 chi         
## 7         120 chi         
## 8         240 chi</code></pre>
<pre class="r"><code>Generate &lt;- function(condition, fixed_objects = NULL) {
    N &lt;- condition$sample_size
    dist &lt;- condition$distribution
    if(dist == &#39;norm&#39;){
        dat &lt;- rnorm(N, mean = 3)
    } else if(dist == &#39;chi&#39;){
        dat &lt;- rchisq(N, df = 3)
    }
    dat
}</code></pre>
<p>Define Bayes estimator of the mean with STAN</p>
<pre class="r"><code># STAN model
bmean_stan &lt;- &quot;
    data {
        int&lt;lower=0&gt; N;
        real x[N];
    }
    parameters {
        real mu;
        real&lt;lower=0&gt; sigma;
    }
    model {
        target += normal_lpdf(mu | 0, 10);  // weakly informative prior
        target += normal_lpdf(x | mu, sigma);
    }
&quot;
# Save file
stan_path &lt;- write_stan_file(bmean_stan)
mod &lt;- cmdstan_model(stan_path)</code></pre>
<pre class="r"><code>Analyse &lt;- function(condition, dat, fixed_objects = NULL) {
    mod &lt;- fixed_objects$mod
    M0 &lt;- mean(dat)
    M1 &lt;- mean(dat, trim = .1)
    M2 &lt;- mean(dat, trim = .2)
    med &lt;- median(dat)
    stan_fit &lt;- quiet(mod$sample(list(x = dat, N = length(dat)),
                                 refresh = 0, chains = 1, 
                                 show_messages = FALSE))
    MB &lt;- stan_fit$summary(&quot;mu&quot;, mean)$mean[1]
    ret &lt;- c(mean_no_trim = M0, mean_trim.1 = M1, 
             mean_trim.2 = M2, median = med, 
             bayes_mean = MB)
    ret
}</code></pre>
<pre class="r"><code>Summarise &lt;- function(condition, results, fixed_objects = NULL) {
    obs_bias &lt;- bias(results, parameter = 3)
    obs_RMSE &lt;- RMSE(results, parameter = 3)
    ret &lt;- c(bias = obs_bias, RMSE = obs_RMSE, RE = RE(obs_RMSE))
    ret
}</code></pre>
<pre class="r"><code>res &lt;- runSimulation(Design, replications = 50, generate = Generate, 
                     analyse = Analyse, summarise = Summarise, 
                     parallel = TRUE,
                     ncores = min(2, parallel::detectCores()), 
                     fixed_objects = list(mod = mod),
                     packages = &quot;cmdstanr&quot;)</code></pre>
<pre><code>## 
## Number of parallel clusters in use: 2</code></pre>
<pre><code>## 
## 
Design row: 1/8;   Started: Fri Jul 16 20:47:30 2021;   Total elapsed time: 0.00s 
## 
## 
Design row: 2/8;   Started: Fri Jul 16 20:47:36 2021;   Total elapsed time: 6.71s 
## 
## 
Design row: 3/8;   Started: Fri Jul 16 20:47:43 2021;   Total elapsed time: 13.57s 
## 
## 
Design row: 4/8;   Started: Fri Jul 16 20:47:50 2021;   Total elapsed time: 20.62s 
## 
## 
Design row: 5/8;   Started: Fri Jul 16 20:47:57 2021;   Total elapsed time: 27.44s 
## 
## 
Design row: 6/8;   Started: Fri Jul 16 20:48:04 2021;   Total elapsed time: 34.50s 
## 
## 
Design row: 7/8;   Started: Fri Jul 16 20:48:11 2021;   Total elapsed time: 41.48s 
## 
## 
Design row: 8/8;   Started: Fri Jul 16 20:48:18 2021;   Total elapsed time: 48.45s</code></pre>
<pre><code>## 
## Simulation complete. Total execution time: 55.24s</code></pre>
<pre class="r"><code>knitr::kable(res)</code></pre>
<table>
<colgroup>
<col width="3%" />
<col width="4%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="3%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="3%" />
<col width="5%" />
<col width="5%" />
<col width="4%" />
<col width="4%" />
<col width="3%" />
<col width="4%" />
<col width="4%" />
<col width="2%" />
<col width="7%" />
<col width="3%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">sample_size</th>
<th align="left">distribution</th>
<th align="right">bias.mean_no_trim</th>
<th align="right">bias.mean_trim.1</th>
<th align="right">bias.mean_trim.2</th>
<th align="right">bias.median</th>
<th align="right">bias.bayes_mean</th>
<th align="right">RMSE.mean_no_trim</th>
<th align="right">RMSE.mean_trim.1</th>
<th align="right">RMSE.mean_trim.2</th>
<th align="right">RMSE.median</th>
<th align="right">RMSE.bayes_mean</th>
<th align="right">RE.mean_no_trim</th>
<th align="right">RE.mean_trim.1</th>
<th align="right">RE.mean_trim.2</th>
<th align="right">RE.median</th>
<th align="right">RE.bayes_mean</th>
<th align="right">REPLICATIONS</th>
<th align="right">SIM_TIME</th>
<th align="left">COMPLETED</th>
<th align="right">SEED</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">30</td>
<td align="left">norm</td>
<td align="right">-0.0143934</td>
<td align="right">-0.0140785</td>
<td align="right">-0.0147392</td>
<td align="right">0.0045262</td>
<td align="right">-0.0166660</td>
<td align="right">0.1956562</td>
<td align="right">0.1971230</td>
<td align="right">0.2040291</td>
<td align="right">0.2316866</td>
<td align="right">0.1938838</td>
<td align="right">1</td>
<td align="right">1.0150497</td>
<td align="right">1.087420</td>
<td align="right">1.402215</td>
<td align="right">0.9819646</td>
<td align="right">50</td>
<td align="right">6.707</td>
<td align="left">Fri Jul 16 20:47:36 2021</td>
<td align="right">1155884559</td>
</tr>
<tr class="even">
<td align="right">60</td>
<td align="left">norm</td>
<td align="right">-0.0122980</td>
<td align="right">-0.0045903</td>
<td align="right">-0.0005297</td>
<td align="right">-0.0105580</td>
<td align="right">-0.0136677</td>
<td align="right">0.1370023</td>
<td align="right">0.1382397</td>
<td align="right">0.1459679</td>
<td align="right">0.1812020</td>
<td align="right">0.1373340</td>
<td align="right">1</td>
<td align="right">1.0181467</td>
<td align="right">1.135165</td>
<td align="right">1.749325</td>
<td align="right">1.0048490</td>
<td align="right">50</td>
<td align="right">6.868</td>
<td align="left">Fri Jul 16 20:47:43 2021</td>
<td align="right">213786095</td>
</tr>
<tr class="odd">
<td align="right">120</td>
<td align="left">norm</td>
<td align="right">0.0208751</td>
<td align="right">0.0217285</td>
<td align="right">0.0264014</td>
<td align="right">0.0256413</td>
<td align="right">0.0209361</td>
<td align="right">0.0907938</td>
<td align="right">0.0893537</td>
<td align="right">0.0929886</td>
<td align="right">0.1156134</td>
<td align="right">0.0903492</td>
<td align="right">1</td>
<td align="right">0.9685308</td>
<td align="right">1.048931</td>
<td align="right">1.621454</td>
<td align="right">0.9902303</td>
<td align="right">50</td>
<td align="right">7.047</td>
<td align="left">Fri Jul 16 20:47:50 2021</td>
<td align="right">1703241818</td>
</tr>
<tr class="even">
<td align="right">240</td>
<td align="left">norm</td>
<td align="right">0.0013774</td>
<td align="right">0.0004119</td>
<td align="right">-0.0008972</td>
<td align="right">-0.0045711</td>
<td align="right">0.0012332</td>
<td align="right">0.0603574</td>
<td align="right">0.0670987</td>
<td align="right">0.0702712</td>
<td align="right">0.0764060</td>
<td align="right">0.0605045</td>
<td align="right">1</td>
<td align="right">1.2358569</td>
<td align="right">1.355482</td>
<td align="right">1.602485</td>
<td align="right">1.0048809</td>
<td align="right">50</td>
<td align="right">6.822</td>
<td align="left">Fri Jul 16 20:47:57 2021</td>
<td align="right">648212189</td>
</tr>
<tr class="odd">
<td align="right">30</td>
<td align="left">chi</td>
<td align="right">0.0680224</td>
<td align="right">-0.2437804</td>
<td align="right">-0.3879277</td>
<td align="right">-0.5058365</td>
<td align="right">0.0626927</td>
<td align="right">0.4134172</td>
<td align="right">0.4867666</td>
<td align="right">0.5835795</td>
<td align="right">0.7087428</td>
<td align="right">0.4069942</td>
<td align="right">1</td>
<td align="right">1.3863230</td>
<td align="right">1.992613</td>
<td align="right">2.939004</td>
<td align="right">0.9691687</td>
<td align="right">50</td>
<td align="right">7.057</td>
<td align="left">Fri Jul 16 20:48:04 2021</td>
<td align="right">293952656</td>
</tr>
<tr class="even">
<td align="right">60</td>
<td align="left">chi</td>
<td align="right">0.0255707</td>
<td align="right">-0.3003029</td>
<td align="right">-0.4448222</td>
<td align="right">-0.6133256</td>
<td align="right">0.0226806</td>
<td align="right">0.2952694</td>
<td align="right">0.4061513</td>
<td align="right">0.5287628</td>
<td align="right">0.7011751</td>
<td align="right">0.2954366</td>
<td align="right">1</td>
<td align="right">1.8920771</td>
<td align="right">3.206897</td>
<td align="right">5.639183</td>
<td align="right">1.0011332</td>
<td align="right">50</td>
<td align="right">6.982</td>
<td align="left">Fri Jul 16 20:48:11 2021</td>
<td align="right">1580098197</td>
</tr>
<tr class="odd">
<td align="right">120</td>
<td align="left">chi</td>
<td align="right">-0.0024911</td>
<td align="right">-0.3544988</td>
<td align="right">-0.5001829</td>
<td align="right">-0.6578762</td>
<td align="right">-0.0042656</td>
<td align="right">0.2053864</td>
<td align="right">0.3991411</td>
<td align="right">0.5312851</td>
<td align="right">0.6957194</td>
<td align="right">0.2069861</td>
<td align="right">1</td>
<td align="right">3.7766732</td>
<td align="right">6.691319</td>
<td align="right">11.474263</td>
<td align="right">1.0156382</td>
<td align="right">50</td>
<td align="right">6.967</td>
<td align="left">Fri Jul 16 20:48:18 2021</td>
<td align="right">1319943732</td>
</tr>
<tr class="even">
<td align="right">240</td>
<td align="left">chi</td>
<td align="right">0.0454342</td>
<td align="right">-0.3016734</td>
<td align="right">-0.4468632</td>
<td align="right">-0.5820299</td>
<td align="right">0.0447952</td>
<td align="right">0.1874962</td>
<td align="right">0.3441907</td>
<td align="right">0.4777899</td>
<td align="right">0.6119982</td>
<td align="right">0.1875163</td>
<td align="right">1</td>
<td align="right">3.3698733</td>
<td align="right">6.493653</td>
<td align="right">10.654070</td>
<td align="right">1.0002148</td>
<td align="right">50</td>
<td align="right">6.795</td>
<td align="left">Fri Jul 16 20:48:25 2021</td>
<td align="right">430065894</td>
</tr>
</tbody>
</table>
