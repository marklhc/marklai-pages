<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mark Lai">
<meta name="dcterms.date" content="2022-05-12">

<title>Mark Lai - Confidence Intervals for Multilevel R-Squared</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NLMBWPMFDG"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NLMBWPMFDG', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Mark Lai</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../post.html" rel="" target="">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publication.html" rel="" target="">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html" rel="" target="">
 <span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../course.html" rel="" target="">
 <span class="menu-text">Courses</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentation.html" rel="" target="">
 <span class="menu-text">Presentations</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-packages" id="toc-load-packages" class="nav-link active" data-scroll-target="#load-packages">Load Packages</a></li>
  <li><a href="#an-example-multilevel-model" id="toc-an-example-multilevel-model" class="nav-link" data-scroll-target="#an-example-multilevel-model">An Example Multilevel Model</a>
  <ul class="collapse">
  <li><a href="#nakagawa-johnson-schielzeth-r2" id="toc-nakagawa-johnson-schielzeth-r2" class="nav-link" data-scroll-target="#nakagawa-johnson-schielzeth-r2">Nakagawa-Johnson-Schielzeth <span class="math inline">\(R^2\)</span></a></li>
  <li><a href="#right-sterba-r2" id="toc-right-sterba-r2" class="nav-link" data-scroll-target="#right-sterba-r2">Right-Sterba <span class="math inline">\(R^2\)</span></a></li>
  </ul></li>
  <li><a href="#confidence-intervals-for-r2" id="toc-confidence-intervals-for-r2" class="nav-link" data-scroll-target="#confidence-intervals-for-r2">Confidence Intervals for <span class="math inline">\(R^2\)</span></a></li>
  <li><a href="#parametric-bootstrap" id="toc-parametric-bootstrap" class="nav-link" data-scroll-target="#parametric-bootstrap">Parametric Bootstrap</a>
  <ul class="collapse">
  <li><a href="#bias-corrected-estimate" id="toc-bias-corrected-estimate" class="nav-link" data-scroll-target="#bias-corrected-estimate">Bias-corrected estimate</a></li>
  <li><a href="#confidence-intervals" id="toc-confidence-intervals" class="nav-link" data-scroll-target="#confidence-intervals">Confidence intervals</a></li>
  </ul></li>
  <li><a href="#residual-bootstrap" id="toc-residual-bootstrap" class="nav-link" data-scroll-target="#residual-bootstrap">Residual Bootstrap</a>
  <ul class="collapse">
  <li><a href="#confidence-intervals-1" id="toc-confidence-intervals-1" class="nav-link" data-scroll-target="#confidence-intervals-1">Confidence Intervals</a></li>
  </ul></li>
  <li><a href="#bootstrap-ci-with-transformation" id="toc-bootstrap-ci-with-transformation" class="nav-link" data-scroll-target="#bootstrap-ci-with-transformation">Bootstrap CI With Transformation</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Confidence Intervals for Multilevel R-Squared</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Statistics</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mark Lai </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 12, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="load-packages" class="level2">
<h2 class="anchored" data-anchor-id="load-packages">Load Packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MuMIn)  <span class="co"># for computing multilevel R-squared</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(r2mlm)  <span class="co"># another package for R-squared</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'nlme'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:lme4':

    lmList</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bootmlm)  <span class="co"># for multilevel bootstrapping</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)  <span class="co"># for bootstrap CIs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="an-example-multilevel-model" class="level2">
<h2 class="anchored" data-anchor-id="an-example-multilevel-model">An Example Multilevel Model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (Days <span class="sc">|</span> Subject), sleepstudy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="nakagawa-johnson-schielzeth-r2" class="level3">
<h3 class="anchored" data-anchor-id="nakagawa-johnson-schielzeth-r2">Nakagawa-Johnson-Schielzeth <span class="math inline">\(R^2\)</span></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">r.squaredGLMM</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 'r.squaredGLMM' now calculates a revised statistic. See the help page.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>           R2m       R2c
[1,] 0.2786511 0.7992199</code></pre>
</div>
</div>
<p>The marginal <span class="math inline">\(R^2\)</span> considers the total variance accounted for due to the fixed effect associated with the predictors (<code>Days</code> in this example). See <a href="https://doi.org/10.1098/rsif.2017.0213">Nakagawa, Johnson, &amp; Schielzeth (2017)</a> for more information.</p>
</section>
<section id="right-sterba-r2" class="level3">
<h3 class="anchored" data-anchor-id="right-sterba-r2">Right-Sterba <span class="math inline">\(R^2\)</span></h3>
<p>More fine-grained partitioning, as described in <a href="https://doi.org/10.1037/met0000184">Rights &amp; Sterba (2019)</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">r2mlm</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/r2mlm-fm1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$Decompositions
                     total
fixed           0.27851304
slope variation 0.08915267
mean variation  0.43165365
sigma2          0.20068063

$R2s
         total
f   0.27851304
v   0.08915267
m   0.43165365
fv  0.36766572
fvm 0.79931937</code></pre>
</div>
</div>
<p>The <code>fixed</code> part is the same as the marginal <span class="math inline">\(R^2\)</span>.</p>
</section>
</section>
<section id="confidence-intervals-for-r2" class="level2">
<h2 class="anchored" data-anchor-id="confidence-intervals-for-r2">Confidence Intervals for <span class="math inline">\(R^2\)</span></h2>
<p>Neither <code>MuMIn::r.squaredGLMM()</code> nor <code>r2mlm::r2mlm()</code> provided confidence intervals (CIs) for the <span class="math inline">\(R^2\)</span>, but general guidelines for effect size reporting would suggest always reporting CIs for point estimates of effect size, just like for any point estimates in statistics. We can use multilevel bootstrapping to get CIs.</p>
<p>To do bootstrap, first defines an R function that gives the target <span class="math inline">\(R^2\)</span> statistics. We can do it for the marginal <span class="math inline">\(R^2\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>marginal_r2 <span class="ot">&lt;-</span> <span class="cf">function</span>(object) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">r.squaredGLMM</span>(object)[[<span class="dv">1</span>]]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">marginal_r2</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2786511</code></pre>
</div>
</div>
</section>
<section id="parametric-bootstrap" class="level2">
<h2 class="anchored" data-anchor-id="parametric-bootstrap">Parametric Bootstrap</h2>
<p>The <code>lme4::bootMer()</code> supports basic parametric multilevel bootstrapping</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes about 30 sec on my computer</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>boo01 <span class="ot">&lt;-</span> <span class="fu">bootMer</span>(fm1, <span class="at">FUN =</span> marginal_r2, <span class="at">nsim =</span> <span class="dv">999</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>boo01</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
PARAMETRIC BOOTSTRAP


Call:
bootMer(x = fm1, FUN = marginal_r2, nsim = 999)


Bootstrap Statistics :
     original      bias    std. error
t1* 0.2786511 0.006541379  0.07553305</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
19 message(s): boundary (singular) fit: see help('isSingular')
7 warning(s): Model failed to converge with max|grad| = 0.00239607 (tol = 0.002, component 1) (and others)</code></pre>
</div>
</div>
<p>Here is the bootstrap distribution</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(boo01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/hist-boo01-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="bias-corrected-estimate" class="level3">
<h3 class="anchored" data-anchor-id="bias-corrected-estimate">Bias-corrected estimate</h3>
<p>The above shows that the sample estimate of <span class="math inline">\(R^2\)</span> was upwardly biased. To correct for the bias, we can use the bootstrap bias-corrected estimate</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="sc">*</span> boo01<span class="sc">$</span>t0 <span class="sc">-</span> <span class="fu">mean</span>(boo01<span class="sc">$</span>t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2721097</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals" class="level3">
<h3 class="anchored" data-anchor-id="confidence-intervals">Confidence intervals</h3>
<p>You can get three types of bootstrap CIs (<code>"norm"</code>, <code>"basic"</code>, <code>"perc"</code>) with <code>bootMer</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>boot<span class="sc">::</span><span class="fu">boot.ci</span>(boo01, <span class="at">index =</span> <span class="dv">1</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"norm"</span>, <span class="st">"basic"</span>, <span class="st">"perc"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 999 bootstrap replicates

CALL : 
boot::boot.ci(boot.out = boo01, type = c("norm", "basic", "perc"), 
    index = 1)

Intervals : 
Level      Normal              Basic              Percentile     
95%   ( 0.1241,  0.4202 )   ( 0.1079,  0.4108 )   ( 0.1465,  0.4494 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
</section>
</section>
<section id="residual-bootstrap" class="level2">
<h2 class="anchored" data-anchor-id="residual-bootstrap">Residual Bootstrap</h2>
<p>The <code>bootmlm::bootstrap_mer()</code> implements the residual bootstrap, which is robust to non-normality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes about 30 sec on my computer</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>boo02 <span class="ot">&lt;-</span> <span class="fu">bootstrap_mer</span>(fm1, <span class="at">FUN =</span> marginal_r2, <span class="at">nsim =</span> <span class="dv">999</span>, <span class="at">type =</span> <span class="st">"residual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>18 message(s) : boundary (singular) fit: see help('isSingular')

1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00211361 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00217517 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.002215 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00255425 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00258348 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00275089 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00410731 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00438296 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00940885 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.0109771 (tol = 0.002, component 1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>boo02</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
bootstrap_mer(x = fm1, FUN = marginal_r2, nsim = 999, type = "residual")


Bootstrap Statistics :
     original    bias    std. error
t1* 0.2786511 0.0061661  0.08425842</code></pre>
</div>
</div>
<p>In this example, the results are similar. The boostrap bias-corrected estimate of <span class="math inline">\(R^2\)</span>, and the three basic CIs, can similarly be computed as in parametric bootstrap.</p>
<section id="confidence-intervals-1" class="level3">
<h3 class="anchored" data-anchor-id="confidence-intervals-1">Confidence Intervals</h3>
<p>In addition to the three CIs previously discussed, which are first-order accurate, we can also obtain CIs that are second-order accurate: (a) bias-corrected and accelerated (BCa) CI and (b) studentized CI (also called the bootstrap-<span class="math inline">\(t\)</span> CI). For (a), it requires the influence value of the <span class="math inline">\(R^2\)</span> function, whereas for (b), it requires an estimate of the sampling variance of the <span class="math inline">\(R^2\)</span> estimate.</p>
<section id="influence-value" class="level4">
<h4 class="anchored" data-anchor-id="influence-value">Influence value</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on the group jackknife</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>inf_val <span class="ot">&lt;-</span> bootmlm<span class="sc">::</span><span class="fu">empinf_mer</span>(fm1, marginal_r2, <span class="at">index =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sampling-variance-with-the-numerical-delta-method" class="level4">
<h4 class="anchored" data-anchor-id="sampling-variance-with-the-numerical-delta-method">Sampling variance with the numerical <a href="https://en.wikipedia.org/wiki/Delta_method">delta method</a></h4>
<blockquote class="blockquote">
<p>This part is a bit more technical; skip this if you’re not interested in the studentized CI.</p>
</blockquote>
<p>To obtain an approximate sampling variance of the <span class="math inline">\(R^2\)</span>, it would be easier to use the <code>r2mlm::r2mlm_manual()</code> function to compute <span class="math inline">\(R^2\)</span>. We first write a function that computes <span class="math inline">\(R^2\)</span> using input of the fixed and random effects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>manual_r2 <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, data,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># The following are model-specific</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">wc =</span> <span class="dv">2</span>, <span class="at">bc =</span> <span class="cn">NULL</span>, <span class="at">rc =</span> <span class="dv">2</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cmc =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  n_wc <span class="ot">&lt;-</span> <span class="fu">length</span>(wc)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  n_bc <span class="ot">&lt;-</span> <span class="fu">length</span>(bc) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  dim_rc <span class="ot">&lt;-</span> <span class="fu">length</span>(rc) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  n_rc <span class="ot">&lt;-</span> dim_rc <span class="sc">*</span> (dim_rc <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  gam_w <span class="ot">&lt;-</span> theta[<span class="fu">seq_len</span>(n_wc)]</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  gam_b <span class="ot">&lt;-</span> theta[n_wc <span class="sc">+</span> <span class="fu">seq_len</span>(n_bc)]</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> dim_rc, <span class="at">ncol =</span> dim_rc)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  tau[<span class="fu">lower.tri</span>(tau, <span class="at">diag =</span> <span class="cn">TRUE</span>)] <span class="ot">&lt;-</span> theta[n_wc <span class="sc">+</span> n_bc <span class="sc">+</span> <span class="fu">seq_len</span>(n_rc)]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> <span class="fu">t</span>(tau)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  tau2[<span class="fu">lower.tri</span>(tau2)] <span class="ot">&lt;-</span> tau[<span class="fu">lower.tri</span>(tau)]</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">&lt;-</span> <span class="fu">tail</span>(theta, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">r2mlm_manual</span>(data,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">within_covs =</span> wc,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">between_covs =</span> bc,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">random_covs =</span> <span class="dv">2</span>,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">gamma_w =</span> gam_w,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">gamma_b =</span> gam_b,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">Tau =</span> tau2,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>               <span class="at">sigma2 =</span> s2,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>               <span class="at">clustermeancentered =</span> cmc,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">bargraph =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>R2s[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>theta_fm1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">fixef</span>(fm1)[<span class="dv">2</span>], <span class="fu">fixef</span>(fm1)[<span class="dv">1</span>],</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>               <span class="fu">VarCorr</span>(fm1)[[<span class="dv">1</span>]][<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>)], <span class="fu">sigma</span>(fm1)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="fu">manual_r2</span>(theta_fm1, <span class="at">data =</span> fm1<span class="sc">@</span>frame)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.278513</code></pre>
</div>
</div>
<p>Now computes the numerical gradient</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>grad_fm1 <span class="ot">&lt;-</span> numDeriv<span class="sc">::</span><span class="fu">grad</span>(manual_r2, <span class="at">x =</span> theta_fm1, <span class="at">data =</span> fm1<span class="sc">@</span>frame)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need the asymptotic covariance matrix of the fixed and random effects</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>vcov_fixed <span class="ot">&lt;-</span> <span class="fu">vcov</span>(fm1)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>vcov_random <span class="ot">&lt;-</span> <span class="fu">vcov_vc</span>(fm1, <span class="at">sd_cor =</span> <span class="cn">FALSE</span>, <span class="at">print_names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .local(x, logarithm, ...): the default value of argument 'sqrt' of
method 'determinant(&lt;CHMfactor&gt;, &lt;logical&gt;)' may change from TRUE to FALSE as
soon as the next release of Matrix; set 'sqrt' when programming</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>vcov_fm1 <span class="ot">&lt;-</span> <span class="fu">bdiag</span>(vcov_fixed, vcov_random)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to re-arrange the first two columns</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>vcov_fm1 <span class="ot">&lt;-</span> vcov_fm1[<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now apply the multivariate delta method</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crossprod</span>(grad_fm1, vcov_fm1) <span class="sc">%*%</span> grad_fm1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 x 1 Matrix of class "dgeMatrix"
            [,1]
[1,] 0.005919918</code></pre>
</div>
</div>
<p>We now need a function that computes both <span class="math inline">\(R^2\)</span> and the asymptotic sampling variance of it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>marginal_r2_with_var <span class="ot">&lt;-</span> <span class="cf">function</span>(object,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">wc =</span> <span class="dv">2</span>, <span class="at">bc =</span> <span class="cn">NULL</span>, <span class="at">rc =</span> <span class="dv">2</span>) {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  dim_rc <span class="ot">&lt;-</span> <span class="fu">length</span>(rc) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  vc_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">seq_len</span>(dim_rc<span class="sc">^</span><span class="dv">2</span>), <span class="at">nrow =</span> dim_rc, <span class="at">ncol =</span> dim_rc)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  vc_index <span class="ot">&lt;-</span> vc_mat[<span class="fu">lower.tri</span>(vc_mat, <span class="at">diag =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  theta_obj <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">fixef</span>(object)[wc], <span class="fu">fixef</span>(object)[<span class="fu">c</span>(<span class="dv">1</span>, bc)],</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">VarCorr</span>(object)[[<span class="dv">1</span>]][vc_index], <span class="fu">sigma</span>(object)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> <span class="fu">manual_r2</span>(theta_obj, <span class="at">data =</span> object<span class="sc">@</span>frame)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  grad_obj <span class="ot">&lt;-</span> numDeriv<span class="sc">::</span><span class="fu">grad</span>(manual_r2, <span class="at">x =</span> theta_obj, <span class="at">data =</span> object<span class="sc">@</span>frame)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Need to re-arrange the order of the fixed effects</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  names_wc <span class="ot">&lt;-</span> <span class="fu">names</span>(object<span class="sc">@</span>frame)[wc]</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  names_bc <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"(Intercept)"</span>, <span class="fu">names</span>(object<span class="sc">@</span>frame)[bc])</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  vcov_fixed <span class="ot">&lt;-</span> <span class="fu">vcov</span>(object)[<span class="fu">c</span>(names_wc, names_bc), <span class="fu">c</span>(names_wc, names_bc)]</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  vcov_random <span class="ot">&lt;-</span> <span class="fu">vcov_vc</span>(object, <span class="at">sd_cor =</span> <span class="cn">FALSE</span>, <span class="at">print_names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  vcov_obj <span class="ot">&lt;-</span> <span class="fu">bdiag</span>(vcov_fixed, vcov_random)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  v_r2 <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(grad_obj, vcov_obj) <span class="sc">%*%</span> grad_obj</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(r2, <span class="fu">as.numeric</span>(v_r2))</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="fu">marginal_r2_with_var</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.278513044 0.005919918</code></pre>
</div>
</div>
</section>
<section id="five-bootstrap-cis" class="level4">
<h4 class="anchored" data-anchor-id="five-bootstrap-cis">Five Bootstrap CIs</h4>
<p>Now, we can do bootstrap again, using the new function that computes both the estimate and the asymptotic sampling variance</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes quite a bit longer due to the need to compute variances</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>boo03 <span class="ot">&lt;-</span> <span class="fu">bootstrap_mer</span>(fm1, <span class="at">FUN =</span> marginal_r2_with_var, <span class="at">nsim =</span> <span class="dv">999</span>,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">type =</span> <span class="st">"residual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>16 message(s) : boundary (singular) fit: see help('isSingular')

1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00219088 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00237722 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00249764 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00264528 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00271037 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00309034 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00349693 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00351591 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00378687 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.00655311 (tol = 0.002, component 1)
1 warning(s) in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,     lbound = lower) : Model failed to converge with max|grad| = 0.0124035 (tol = 0.002, component 1)
2 warning(s) in sqrt(diag(m)) : NaNs produced</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>boo03</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
bootstrap_mer(x = fm1, FUN = marginal_r2_with_var, nsim = 999, 
    type = "residual")


Bootstrap Statistics :
       original        bias    std. error
t1* 0.278513044  0.0104280454 0.083466874
t2* 0.005919918 -0.0002962603 0.001142685</code></pre>
</div>
</div>
<p>And then obtain five types of CIs</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>boot<span class="sc">::</span><span class="fu">boot.ci</span>(boo03, <span class="at">L =</span> inf_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 997 bootstrap replicates

CALL : 
boot::boot.ci(boot.out = boo03, L = inf_val)

Intervals : 
Level      Normal              Basic             Studentized     
95%   ( 0.1045,  0.4317 )   ( 0.0898,  0.4062 )   ( 0.0819,  0.4380 )  

Level     Percentile            BCa          
95%   ( 0.1509,  0.4673 )   ( 0.1383,  0.4448 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="bootstrap-ci-with-transformation" class="level2">
<h2 class="anchored" data-anchor-id="bootstrap-ci-with-transformation">Bootstrap CI With Transformation</h2>
<p>Given that <span class="math inline">\(R^2\)</span> is bounded, it may be more accurate to first transform the <span class="math inline">\(R^2\)</span> estimates to an unbounded scale, obtain the CIs on the transformed scale, and then back transform it to between 0 and 1. This can be done in <code>boot::boot.ci()</code> as well with the logistic transformation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>boot<span class="sc">::</span><span class="fu">boot.ci</span>(boo03, <span class="at">L =</span> inf_val, <span class="at">h =</span> qlogis,</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Need the derivative of the transformation</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">hdot =</span> <span class="cf">function</span>(x) <span class="dv">1</span> <span class="sc">/</span> (x <span class="sc">-</span> x<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">hinv =</span> plogis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 997 bootstrap replicates

CALL : 
boot::boot.ci(boot.out = boo03, L = inf_val, h = qlogis, hdot = function(x) 1/(x - 
    x^2), hinv = plogis)

Intervals : 
Level      Normal              Basic             Studentized     
95%   ( 0.1440,  0.4616 )   ( 0.1452,  0.4561 )   ( 0.1181,  0.4184 )  

Level     Percentile            BCa          
95%   ( 0.1509,  0.4673 )   ( 0.1383,  0.4448 )  
Calculations on Transformed Scale;  Intervals on Original Scale</code></pre>
</div>
</div>
<p>Note that the transformation only affects the Normal, Basic, and Studentized CIs.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This post demonstrates how to use multilevel bootstrapping to obtain CIs for <span class="math inline">\(R^2\)</span>. The post only focuses on marginal <span class="math inline">\(R^2\)</span>, but CIs for other <span class="math inline">\(R^2\)</span> measures can be similarly obtained. The studentized CI is the most complex as it requires obtaining the sampling variance of <span class="math inline">\(R^2\)</span> for each bootstrap sample. So far, to my knowledge, there has not been studies on which CI(s) perform best, so simulation studies are needed.</p>
<p>Further readings on multilevel bootstrap:</p>
<ul>
<li><a href="https://link.springer.com/chapter/10.1007/978-0-387-73186-5_11">Chapter by van der Leeden et al.</a></li>
<li><a href="https://doi.org/10.1080/00273171.2020.1746902">Paper by Lai</a></li>
<li><a href="https://doi.org/10.1017/CBO9780511802843">Book by Davison &amp; Hinkley</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Copyright 2023, Hok Chio (Mark) Lai</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>