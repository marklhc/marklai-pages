<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mark Lai">
<meta name="dcterms.date" content="2020-06-12">

<title>Mark Lai - Weighted Least Squares</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NLMBWPMFDG"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NLMBWPMFDG', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Mark Lai</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../post.html" rel="" target="">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publication.html" rel="" target="">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html" rel="" target="">
 <span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../course.html" rel="" target="">
 <span class="menu-text">Courses</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentation.html" rel="" target="">
 <span class="menu-text">Presentations</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-packages" id="toc-load-packages" class="nav-link active" data-scroll-target="#load-packages">Load packages</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#polychoric-correlations" id="toc-polychoric-correlations" class="nav-link" data-scroll-target="#polychoric-correlations">Polychoric Correlations</a>
  <ul class="collapse">
  <li><a href="#lavaan" id="toc-lavaan" class="nav-link" data-scroll-target="#lavaan"><code>lavaan</code></a></li>
  <li><a href="#openmx" id="toc-openmx" class="nav-link" data-scroll-target="#openmx">OpenMx</a></li>
  </ul></li>
  <li><a href="#weighted-least-squares-estimation" id="toc-weighted-least-squares-estimation" class="nav-link" data-scroll-target="#weighted-least-squares-estimation">Weighted Least Squares Estimation</a>
  <ul class="collapse">
  <li><a href="#one-factor-model" id="toc-one-factor-model" class="nav-link" data-scroll-target="#one-factor-model">One-factor model</a></li>
  <li><a href="#standard-errors" id="toc-standard-errors" class="nav-link" data-scroll-target="#standard-errors">Standard Errors</a></li>
  </ul></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Weighted Least Squares</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Statistics</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mark Lai </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 12, 2020</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>Recently I was working on a revision for a paper that involves structural equation modeling with categorical observed variables, and it uses a robust variant of weighted least square (also called asymptotic distribution free) estimators. Even though I had some basic understanding of WLS, the experience made me aware that I hadn’t fully understand how it was implemented in software. Therefore, I decided to write a (not so) short note to show how the polychoric correlation matrix can be estimated, and then how the weighted least squares estimation can be applied.</p>
<section id="load-packages" class="level2">
<h2 class="anchored" data-anchor-id="load-packages">Load packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lavaan)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)  <span class="co"># for plotting</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(polycor)  <span class="co"># for estimating polychoric correlations</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(numDeriv)  <span class="co"># getting numerical derivatives</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey85"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>The data will be three variables from the classic Holzinger &amp; Swineford (1939) data set. The variables are</p>
<ul>
<li><code>x1</code>: Visual perception</li>
<li><code>x2</code>: Cubes</li>
<li><code>x3</code>: Lozenges</li>
</ul>
<p>To illustrate categorical variables, I’ll categorize each of the variables into three categories using the <code>cut</code> function in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Holzinger and Swineford (1939) example</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>HS3 <span class="ot">&lt;-</span> HolzingerSwineford1939[ , <span class="fu">c</span>(<span class="st">"x1"</span>,<span class="st">"x2"</span>,<span class="st">"x3"</span>)]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ordinal version, with three categories</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>HS3ord <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">lapply</span>(HS3, <span class="cf">function</span>(v) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.ordered</span>(<span class="fu">cut</span>(v, <span class="at">breaks =</span> <span class="dv">3</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the contingency table of the first two items</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(HS3ord[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    x2
#&gt; x1    1   2   3
#&gt;   1   4  19   3
#&gt;   2  12 162  41
#&gt;   3   2  33  25</code></pre>
</div>
</div>
</section>
<section id="polychoric-correlations" class="level2">
<h2 class="anchored" data-anchor-id="polychoric-correlations">Polychoric Correlations</h2>
<p>To use WLS, we first assume that each categorical variable has an underlying normal variate that has been categorized, and usually it’s assumed to be a standard normal variable so that the scale can be fixed. Based on the contingency table for each pair of observed variables, we infer the correlation of the corresponding pair of underlying response variates. That correlation is called the <strong>polychoric correlation</strong>.</p>
<section id="lavaan" class="level3">
<h3 class="anchored" data-anchor-id="lavaan"><code>lavaan</code></h3>
<p>There are different ways to estimate the polychoric correlations, but generally it involves numerical optimization to find maximum likelihood or psuedo maximum likelihood values. In <code>lavaan</code> it is easy to estimate that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># polychoric correlations, two-stage estimation</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>pcor_lavaan <span class="ot">&lt;-</span> <span class="fu">lavCor</span>(HS3ord, <span class="at">ordered =</span> <span class="fu">names</span>(HS3ord), </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">se =</span> <span class="st">"robust.sem"</span>, <span class="at">output =</span> <span class="st">"fit"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameterestimates</span>(pcor_lavaan), </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  op <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"~~"</span>, <span class="st">"|"</span>)  <span class="co"># polychoric correlations and thresholds</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    lhs op rhs    est    se       z pvalue ci.lower ci.upper
#&gt; 1   x1 ~~  x1  1.000 0.000      NA     NA    1.000    1.000
#&gt; 2   x2 ~~  x2  1.000 0.000      NA     NA    1.000    1.000
#&gt; 3   x3 ~~  x3  1.000 0.000      NA     NA    1.000    1.000
#&gt; 4   x1 ~~  x2  0.317 0.070   4.534      0    0.180    0.455
#&gt; 5   x1 ~~  x3  0.508 0.060   8.484      0    0.391    0.625
#&gt; 6   x2 ~~  x3  0.304 0.066   4.616      0    0.175    0.433
#&gt; 7   x1  |  t1 -1.363 0.103 -13.239      0   -1.565   -1.162
#&gt; 8   x1  |  t2  0.844 0.083  10.224      0    0.682    1.006
#&gt; 9   x2  |  t1 -1.556 0.115 -13.508      0   -1.782   -1.331
#&gt; 10  x2  |  t2  0.741 0.080   9.259      0    0.584    0.898
#&gt; 11  x3  |  t1 -0.353 0.074  -4.766      0   -0.498   -0.208
#&gt; 12  x3  |  t2  0.626 0.078   8.047      0    0.473    0.778</code></pre>
</div>
</div>
<p>The default in <code>lavaan</code> uses a two-stage estimator that first obtains the maximum likelihood estimate of the thresholds, and then obtain the polychoric correlation using the <code>DWLS</code> estimator with robust standard errors, which will be further discussed.</p>
<section id="thresholds" class="level4">
<h4 class="anchored" data-anchor-id="thresholds">Thresholds</h4>
<p>The thresholds are the cut points in the underlying standard normal distribution. For example, the proportions for <code>x1</code> are</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(prop_x1 <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(HS3ord<span class="sc">$</span>x1)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt;          1          2          3 
#&gt; 0.08637874 0.71428571 0.19933555</code></pre>
</div>
</div>
<p>This suggests that a sensible way to estimate these cut points is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(thresholds_x1 <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="fu">cumsum</span>(prop_x1)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;         1         2         3 
#&gt; -1.363397  0.843997       Inf</code></pre>
</div>
</div>
<p>which basically matches the estimates in <code>lavaan</code>. Do the same for <code>x2</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(thresholds_x2 <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="fu">cumsum</span>(<span class="fu">prop.table</span>(<span class="fu">table</span>(HS3ord<span class="sc">$</span>x2)))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;          1          2          3 
#&gt; -1.5564491  0.7413657        Inf</code></pre>
</div>
</div>
<p>Note that there are only two thresholds with three categories. This may be more readily seen in a graph:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">xstar =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>)), </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> xstar)) <span class="sc">+</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm) <span class="sc">+</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">tau =</span> thresholds_x2[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">density =</span> <span class="fu">dnorm</span>(thresholds_x2[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> tau, <span class="at">xend =</span> tau, <span class="at">y =</span> density, <span class="at">yend =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/thresh-x1-graph-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The conversion using the cumulative normal density to obtain the thresholds is equivalent to obtaining <span class="math inline">\(\tau_j\)</span> for the <span class="math inline">\(j\)</span>th threshold (<span class="math inline">\(j = 1, 2\)</span>) as solving for <span class="math display">\[\Phi(\tau_j) - \Phi(\tau_{j - 1}) = \frac{\sum_i [x_i = j]}{N}, \]</span> where <span class="math inline">\(\Phi(\cdot)\)</span> is the standard normal cdf (i.e., <code>pnorm()</code> in R), <span class="math inline">\(\sum_i [x_i = j] = n_j\)</span> is the count of <span class="math inline">\(x_i\)</span> that equals <span class="math inline">\(j\)</span>, <span class="math inline">\(\Phi(\tau_0) = 0\)</span>, and <span class="math inline">\(\Phi(\tau_3) = 1\)</span>. Writing it this way would make it clearer how the standard errors (<em>SE</em>s) of the <span class="math inline">\(\tau\)</span>s can be obtained. In practice, most software uses maximum likelihood estimation and obtain the asymptotic <em>SE</em>s by inverting the Hessian. Here’s an example to get the same results as in <code>lavaan</code> for the thresholds of <code>x1</code>, which minimizes <span class="math display">\[Q(\tau_1, \tau_2) = \sum_{j = 1}^3 n_j \log [\Phi(\tau_j) - \Phi(\tau_{j - 1})]\]</span> (see <a href="https://doi.org/10.1007/s11336-016-9512-2">Jin &amp; Yang-Wallentin, 2017</a>, for example.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>lastx <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x[<span class="fu">length</span>(x)]  <span class="co"># helper for last element</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimization criterion</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="cf">function</span>(taus, <span class="at">ns =</span> <span class="fu">table</span>(HS3ord[ , <span class="dv">1</span>])) {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  hs <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(taus)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  hs <span class="ot">&lt;-</span> <span class="fu">c</span>(hs[<span class="dv">1</span>], <span class="fu">diff</span>(hs), <span class="dv">1</span> <span class="sc">-</span> <span class="fu">lastx</span>(hs))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span> <span class="fu">sum</span>(ns <span class="sc">*</span> <span class="fu">log</span>(hs))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>taus1_optim <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), Q, <span class="at">hessian =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to lavaan</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="st">`</span><span class="at">lavaan</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">parameterEstimates</span>(pcor_lavaan)[<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>, <span class="fu">c</span>(<span class="st">"est"</span>, <span class="st">"se"</span>)], </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>     <span class="st">`</span><span class="at">optim</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">est =</span> taus1_optim<span class="sc">$</span>par, </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">se =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(taus1_optim<span class="sc">$</span>hessian)))</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; $lavaan
#&gt;      est    se
#&gt; 7 -1.363 0.103
#&gt; 8  0.844 0.083
#&gt; 
#&gt; $optim
#&gt;          est        se
#&gt; 1 -1.3639182 0.1028333
#&gt; 2  0.8440422 0.0824186</code></pre>
</div>
</div>
<p>They are not exactly the same but are pretty close.</p>
</section>
<section id="polychoric-correlations-1" class="level4">
<h4 class="anchored" data-anchor-id="polychoric-correlations-1">Polychoric correlations</h4>
<p>Whereas the thresholds can be computed based on the proportions of each individual variable, the polychoric correlation needs the contingency table between two variables. The underlying variates are assumed to follow a bivariate normal distribution, which an example (with <span class="math inline">\(r = .3\)</span>) shown below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>expand_grid_matrix <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="fu">rep</span>(x, <span class="fu">length</span>(y)), </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rep</span>(y, <span class="at">each =</span> <span class="fu">length</span>(x)))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>x_pts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">29</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>y_pts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">29</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>xy_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid_matrix</span>(<span class="at">x =</span> x_pts, <span class="at">y =</span> y_pts)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>example_sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, .<span class="dv">3</span>, .<span class="dv">3</span>, <span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>z_pts <span class="ot">&lt;-</span> <span class="fu">dmvnorm</span>(xy_grid, <span class="at">sigma =</span> example_sigma)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>z_grid <span class="ot">&lt;-</span> <span class="fu">matrix</span>(z_pts, <span class="at">nrow =</span> <span class="dv">29</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">persp</span>(x_pts, y_pts, z_grid, <span class="at">theta =</span> <span class="dv">15</span>, <span class="at">phi =</span> <span class="dv">30</span>, <span class="at">expand =</span> <span class="fl">0.5</span>, </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="st">"lightblue"</span>, <span class="at">box =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/bivariate-density-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>With the thresholds set, a bivariate normal distribution will be cut into 9 quadrants when each item has 3 categories:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> xy_grid[ , <span class="dv">1</span>], </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">y =</span> xy_grid[ , <span class="dv">2</span>], </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">z =</span> z_pts), </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(x, y, <span class="at">z =</span> z)) <span class="sc">+</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_contour</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.1</span>)) <span class="sc">+</span> </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> thresholds_x1) <span class="sc">+</span> </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> thresholds_x2) <span class="sc">+</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"x1"</span>, <span class="at">y =</span> <span class="st">"x2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/contour-x1-x2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The main goal is to find a correlation, <span class="math inline">\(\rho\)</span>, such that the implied proportions match the observed contingency table as closely as possible:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>table_x1x2 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(HS3ord, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">prop.table</span>(<span class="fu">table</span>(x1, x2)) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> table_x1x2, <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2)) <span class="sc">+</span> </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Freq)) <span class="sc">+</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">high =</span> <span class="st">"red"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">space =</span> <span class="st">"Lab"</span>, </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>   <span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Freq), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; Warning: The `&lt;scale&gt;` argument of `guides()` cannot be `FALSE`. Use "none" instead as
#&gt; of ggplot2 3.3.4.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot-table-HS3ord-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>For example, if <span class="math inline">\(\rho = .3\)</span>, the implied proportions are</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bivariate normal probability</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>pbivariatenormal <span class="ot">&lt;-</span> <span class="cf">function</span>(lower, upper, rho) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  mvtnorm<span class="sc">::</span><span class="fu">pmvnorm</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> lower, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> upper, </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">corr =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho, rho, <span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>lower_lims <span class="ot">&lt;-</span> <span class="fu">expand_grid_matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, thresholds_x1[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, thresholds_x2[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]))</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>upper_lims <span class="ot">&lt;-</span> <span class="fu">expand_grid_matrix</span>(<span class="fu">c</span>(thresholds_x1[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="cn">Inf</span>), </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">c</span>(thresholds_x2[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="cn">Inf</span>))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(lower_lims)), </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>         <span class="cf">function</span>(i, <span class="at">r =</span> .<span class="dv">3</span>) <span class="fu">pbivariatenormal</span>(lower_lims[i, ], </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>                                              upper_lims[i, ], </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                                              r), </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix</span>(<span class="fu">round</span>(probs <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;      [,1]  [,2]  [,3]
#&gt; [1,] 1.27  6.59  0.78
#&gt; [2,] 4.31 52.34 14.78
#&gt; [3,] 0.40 12.17  7.36</code></pre>
</div>
</div>
<p>which is not too far away. An optimization algorithm for the (pseudo-) maximum likelihood estimates can be obtained by minimizing <span class="math display">\[\sum_{j = 1}^3 \sum_{k = 1}^3 p_{jk} \log \pi_{jk},\]</span></p>
<p>(<a href="https://doi.org/10.1007/s11336-016-9512-2">Jin &amp; Yang-Wallentin, 2017</a>, p.&nbsp;71)</p>
<p>where <span class="math inline">\(p_{jk}\)</span> is the observed proportions and <span class="math inline">\(\pi_{jk}\)</span> is the implied proportions with a given correlation <span class="math inline">\(\rho\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>likelihood_pcor <span class="ot">&lt;-</span> <span class="cf">function</span>(rho, <span class="at">ns =</span> <span class="fu">table</span>(HS3ord[ , <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">taus =</span> <span class="fu">cbind</span>(thresholds_x1[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                                         thresholds_x2[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  taus1 <span class="ot">&lt;-</span> taus[ , <span class="dv">1</span>]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  taus2 <span class="ot">&lt;-</span> taus[ , <span class="dv">2</span>]</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  lower_lims <span class="ot">&lt;-</span> <span class="fu">expand_grid_matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, taus1), </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, taus2))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  upper_lims <span class="ot">&lt;-</span> <span class="fu">expand_grid_matrix</span>(<span class="fu">c</span>(taus1, <span class="cn">Inf</span>), </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">c</span>(taus2, <span class="cn">Inf</span>))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  probs <span class="ot">&lt;-</span> </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(lower_lims)), </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>           <span class="cf">function</span>(i, <span class="at">r =</span> rho) <span class="fu">pbivariatenormal</span>(lower_lims[i, ], </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                                                 upper_lims[i, ], </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                                                 r), </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span> <span class="fu">sum</span>(ns <span class="sc">*</span> <span class="fu">log</span>(probs))</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>pcor_optim <span class="ot">&lt;-</span> </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">optim</span>(<span class="dv">0</span>, likelihood_pcor, <span class="at">lower =</span> <span class="sc">-</span>.<span class="dv">995</span>, <span class="at">upper =</span> .<span class="dv">995</span>, <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>, </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">hessian =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to lavaan</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="st">`</span><span class="at">lavaan</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">parameterEstimates</span>(pcor_lavaan)[<span class="dv">4</span>, <span class="fu">c</span>(<span class="st">"est"</span>, <span class="st">"se"</span>)], </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>     <span class="st">`</span><span class="at">optim</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">est =</span> pcor_optim<span class="sc">$</span>par, </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">se =</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">/</span> pcor_optim<span class="sc">$</span>hessian)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;          est    se
#&gt; lavaan 0.317 0.070
#&gt; optim  0.317 0.075</code></pre>
</div>
</div>
<p>The <em>SE</em> estimates are different because <code>optim</code> uses maximum likelihood, whereas <code>lavaan</code> uses WLS-type estimates. You will see the values with ML in <code>OpenMx</code> is closer below.</p>
</section>
</section>
<section id="openmx" class="level3">
<h3 class="anchored" data-anchor-id="openmx">OpenMx</h3>
<p>With OpenMx, the polychoric correlations can be estimated directly with maximum likelihood or weighted least squares. First, with <code>DWLS</code> that should give similar results as <code>lavaan</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OpenMx</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(OpenMx)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>polychoric_mxmodel <span class="ot">&lt;-</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mxModel</span>(<span class="at">model =</span> <span class="st">"polychoric"</span>, </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"RAM"</span>, </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mxData</span>(HS3ord, <span class="at">type =</span> <span class="st">"raw"</span>), </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">manifestVars =</span> <span class="fu">names</span>(HS3ord), </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mxPath</span>(<span class="at">from =</span> <span class="fu">names</span>(HS3ord), <span class="at">connect =</span> <span class="st">"unique.bivariate"</span>, </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">arrows =</span> <span class="dv">2</span>, <span class="at">free =</span> <span class="cn">TRUE</span>, <span class="at">values =</span> .<span class="dv">3</span>), </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mxPath</span>(<span class="at">from =</span> <span class="fu">names</span>(HS3ord), </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">arrows =</span> <span class="dv">2</span>, <span class="at">free =</span> <span class="cn">FALSE</span>, <span class="at">values =</span> <span class="dv">1</span>), </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mxPath</span>(<span class="at">from =</span> <span class="st">"one"</span>, <span class="at">to =</span> <span class="fu">names</span>(HS3ord), </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">arrows =</span> <span class="dv">1</span>, <span class="at">free =</span> <span class="cn">FALSE</span>, <span class="at">values =</span> <span class="dv">0</span>), </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mxThreshold</span>(<span class="at">vars =</span> <span class="fu">names</span>(HS3ord), <span class="at">nThresh =</span> <span class="dv">2</span>, </span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">free =</span> <span class="cn">TRUE</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mxRun</span>(</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mxModel</span>(polychoric_mxmodel, </span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mxFitFunctionWLS</span>(<span class="st">"DWLS"</span>))</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Summary of polychoric 
#&gt;  
#&gt; free parameters:
#&gt;                         name     matrix row col   Estimate  Std.Error
#&gt; 1          polychoric.S[1,2]          S  x1  x2  0.3173173 0.06988377
#&gt; 2          polychoric.S[1,3]          S  x1  x3  0.5079673 0.05978313
#&gt; 3          polychoric.S[2,3]          S  x2  x3  0.3039566 0.06572188
#&gt; 4 polychoric.Thresholds[1,1] Thresholds   1  x1 -1.3633968 0.10281052
#&gt; 5 polychoric.Thresholds[2,1] Thresholds   2  x1  0.8439970 0.08241477
#&gt; 6 polychoric.Thresholds[1,2] Thresholds   1  x2 -1.5564491 0.11503135
#&gt; 7 polychoric.Thresholds[2,2] Thresholds   2  x2  0.7413657 0.07993884
#&gt; 8 polychoric.Thresholds[1,3] Thresholds   1  x3 -0.3527812 0.07389738
#&gt; 9 polychoric.Thresholds[2,3] Thresholds   2  x3  0.6256117 0.07762006
#&gt; 
#&gt; Model Statistics: 
#&gt;                |  Parameters  |  Degrees of Freedom  |  Fit (r'wr units)
#&gt;        Model:              9                      0                   NA
#&gt;    Saturated:              9                      0                    0
#&gt; Independence:              6                      3                   NA
#&gt; Number of observations/statistics: 301/9
#&gt; 
#&gt; chi-square:  χ² ( df=0 ) = 0,  p = 1
#&gt; CFI: NA 
#&gt; TLI: 1   (also known as NNFI) 
#&gt; RMSEA:  0  [95% CI (NA, NA)]
#&gt; Prob(RMSEA &lt;= 0.05): NA
#&gt; To get additional fit indices, see help(mxRefModels)
#&gt; timestamp: 2023-08-10 23:06:04 
#&gt; Wall clock time: 0.05692291 secs 
#&gt; optimizer:  SLSQP 
#&gt; OpenMx version number: 2.21.8 
#&gt; Need help?  See help(mxSummary)</code></pre>
</div>
</div>
<p>With ML</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mxRun</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mxModel</span>(polychoric_mxmodel, </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mxFitFunctionML</span>())</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Summary of polychoric 
#&gt;  
#&gt; free parameters:
#&gt;                         name     matrix row col   Estimate  Std.Error A
#&gt; 1          polychoric.S[1,2]          S  x1  x2  0.3166411 0.07631802  
#&gt; 2          polychoric.S[1,3]          S  x1  x3  0.5080022 0.06299348  
#&gt; 3          polychoric.S[2,3]          S  x2  x3  0.3090142 0.07183812  
#&gt; 4 polychoric.Thresholds[1,1] Thresholds   1  x1 -1.3737991 0.10400215  
#&gt; 5 polychoric.Thresholds[2,1] Thresholds   2  x1  0.8411834 0.08187341  
#&gt; 6 polychoric.Thresholds[1,2] Thresholds   1  x2 -1.5475371 0.11402095  
#&gt; 7 polychoric.Thresholds[2,2] Thresholds   2  x2  0.7410892 0.08015387  
#&gt; 8 polychoric.Thresholds[1,3] Thresholds   1  x3 -0.3430065 0.07407156  
#&gt; 9 polychoric.Thresholds[2,3] Thresholds   2  x3  0.6277570 0.07713488  
#&gt; 
#&gt; Model Statistics: 
#&gt;                |  Parameters  |  Degrees of Freedom  |  Fit (-2lnL units)
#&gt;        Model:              9                    894              1502.269
#&gt;    Saturated:              9                    894                    NA
#&gt; Independence:              6                    897                    NA
#&gt; Number of observations/statistics: 301/903
#&gt; 
#&gt; Information Criteria: 
#&gt;       |  df Penalty  |  Parameters Penalty  |  Sample-Size Adjusted
#&gt; AIC:       -285.731               1520.269                 1520.888
#&gt; BIC:      -3599.888               1553.633                 1525.090
#&gt; CFI: NA 
#&gt; TLI: 1   (also known as NNFI) 
#&gt; RMSEA:  0  [95% CI (NA, NA)]
#&gt; Prob(RMSEA &lt;= 0.05): NA
#&gt; To get additional fit indices, see help(mxRefModels)
#&gt; timestamp: 2023-08-10 23:06:04 
#&gt; Wall clock time: 0.09280849 secs 
#&gt; optimizer:  SLSQP 
#&gt; OpenMx version number: 2.21.8 
#&gt; Need help?  See help(mxSummary)</code></pre>
</div>
</div>
<p>The <span class="math inline">\(p(p - 1) / 2 \times p(p - 1) / 2\)</span> asymptotic covariance matrix of the polychoric correlations will be used to obtain robust standard errors with the WLS estimators. I’ll see the one from <code>lavaan</code> for consistency.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(acov_pcor <span class="ot">&lt;-</span> <span class="fu">vcov</span>(pcor_lavaan)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;             x1~~x2       x1~~x3       x2~~x3
#&gt; x1~~x2 0.004899261 0.0011380143 0.0018417210
#&gt; x1~~x3 0.001138014 0.0035854771 0.0005619927
#&gt; x2~~x3 0.001841721 0.0005619927 0.0043343069</code></pre>
</div>
</div>
<p>I’ll now move to WLS.</p>
</section>
</section>
<section id="weighted-least-squares-estimation" class="level2">
<h2 class="anchored" data-anchor-id="weighted-least-squares-estimation">Weighted Least Squares Estimation</h2>
<p>The WLS estimator in SEM has a discrepancy function <span class="math display">\[F(\boldsymbol{\mathbf{\theta}}) = (\hat{\boldsymbol{\mathbf{\rho}}} - \boldsymbol{\mathbf{\rho}}(\boldsymbol{\mathbf{\theta}}))^\top \hat{\boldsymbol{\mathbf{W}}} (\hat{\boldsymbol{\mathbf{\rho}}} - \boldsymbol{\mathbf{\rho}}(\boldsymbol{\mathbf{\theta}})), \]</span> where <span class="math inline">\(\hat{\boldsymbol{\mathbf{\rho}}}\)</span> is a column vector of the estimated unique polychoric correlations, <span class="math inline">\(bv \rho(\boldsymbol{\mathbf{\theta}})\)</span> is the vector of model-implied polychoric correlations given the model parameters <span class="math inline">\(\boldsymbol{\mathbf{\theta}}\)</span>, and <span class="math inline">\(\hat{\boldsymbol{\mathbf{W}}}\)</span> is some weight matrix. The WLS estimator uses the inverse of the asymptotic covariance matrix of the polychoric correlations, i.e., <span class="math inline">\(\hat{\boldsymbol{\mathbf{W}}} = \hat{\boldsymbol{\mathbf{\Sigma}}}^{-1}_{\rho \rho}\)</span>. However, when the number of variables is large, inverting this large matrix is computationally demanding, and previous studies have shown that WLS did not work well until the sample size is large (e.g., <span class="math inline">\(&gt; 2,000\)</span>).</p>
<p>A more popular variant is to instead use only the diagonals in <span class="math inline">\(\hat{\boldsymbol{\mathbf{\Sigma}}}^{-1}_{\rho \rho}\)</span> to form the weight matrix, which requires only taking inverse of the individual elements. In other words, <span class="math inline">\(\hat{\boldsymbol{\mathbf{W}}} = \mathrm{diag} \hat{\boldsymbol{\mathbf{\Sigma}}}^{-1}_{\rho \rho}\)</span>. This is called the diagonally-weighted least squares (DWLS) estimation. In Mplus and <code>lavaan</code>, there are variants such as WLSM, WLSMV, etc, but they differ mainly in the test statistics computed, while the parameter estimates are all based on the DWLS estimator.</p>
<section id="one-factor-model" class="level3">
<h3 class="anchored" data-anchor-id="one-factor-model">One-factor model</h3>
<p>As an example, consider the one-factor model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># One-factor model</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>onefactor_fit <span class="ot">&lt;-</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cfa</span>(<span class="st">' f =~ x1 + x2 + x3 '</span>, <span class="at">ordered =</span> <span class="fu">c</span>(<span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>), </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> HS3ord, <span class="at">std.lv =</span> <span class="cn">TRUE</span>, <span class="at">estimator =</span> <span class="st">"WLSMV"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Aside from the threshold parameters, which was estimated in the first stage, the model only has three loading parameter <span class="math inline">\(\boldsymbol{\mathbf{\lambda}}\)</span>. To obtain the estimates from scratch, we can use the estimated polychoric correlation and the diagonal of the asymptotic covariance matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>rhos_hat <span class="ot">&lt;-</span> <span class="fu">coef</span>(pcor_lavaan)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>acov_rhos <span class="ot">&lt;-</span> <span class="fu">vcov</span>(pcor_lavaan)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ase_rhos <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(acov_rhos))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the <span class="math inline">\(\boldsymbol{\mathbf{\rho}}(\boldsymbol{\mathbf{\theta}})\)</span> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for model-implied correlation (delta parameterization)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>implied_cor <span class="ot">&lt;-</span> <span class="cf">function</span>(lambdas) {</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  lambdalambdat <span class="ot">&lt;-</span> <span class="fu">tcrossprod</span>(lambdas)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  lambdalambdat[<span class="fu">lower.tri</span>(lambdalambdat)]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># implied_cor(rep(.7, 3))  # example</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and define the discrepancy function. Note that with DWLS, <span class="math display">\[\hat{\boldsymbol{\mathbf{W}}} = \mathrm{diag} \hat{\boldsymbol{\mathbf{\Sigma}}}^{-1}_{\rho \rho} = \hat{\boldsymbol{\mathbf{D}}}^{-1}_{\rho \rho} \hat{\boldsymbol{\mathbf{D}}}^{-1}_{\rho \rho}, \]</span> where <span class="math inline">\(\hat{\boldsymbol{\mathbf{D}}}^{-1}_{\rho \rho}\)</span> is a diagonal matrix containing the asymptotic standard errors (i.e., square root of the variances).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Discrepancy function</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>dwls_fitfunction <span class="ot">&lt;-</span> <span class="cf">function</span>(lambdas, </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sample_cors =</span> rhos_hat, </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ase_cors =</span> ase_rhos) {</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">implied_cor</span>(lambdas) <span class="sc">-</span> sample_cors) <span class="sc">/</span> ase_cors</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>optim_lambdas <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="fu">rep</span>(.<span class="dv">7</span>, <span class="dv">3</span>), dwls_fitfunction)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to lavaan</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="st">`</span><span class="at">lavaan</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">coef</span>(onefactor_fit)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>     <span class="st">`</span><span class="at">optim</span><span class="st">`</span> <span class="ot">=</span> optim_lambdas<span class="sc">$</span>par</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;          lavaan     optim
#&gt; f=~x1 0.7283664 0.7283460
#&gt; f=~x2 0.4357404 0.4357493
#&gt; f=~x3 0.6974518 0.6974572</code></pre>
</div>
</div>
</section>
<section id="standard-errors" class="level3">
<h3 class="anchored" data-anchor-id="standard-errors">Standard Errors</h3>
<p>The discussion of this section draws on the materials in <a href="https://doi.org/10.1007/%20S%2011336-007-9006-3">Bollen &amp; Maydeu-Olivares (2007)</a>. Using a first-order approximation, the asymptotic covariance matrix of the WLS estimator is <span class="math inline">\((\boldsymbol{\mathbf{\Delta}}^\top (\boldsymbol{\mathbf{\theta}}) \boldsymbol{\mathbf{\Sigma}}^{-1}_{\rho \rho}\boldsymbol{\mathbf{\Delta}})^{-1}\)</span>, where <span class="math inline">\(\boldsymbol{\mathbf{\Delta }}= \partial \boldsymbol{\mathbf{\rho}}(\boldsymbol{\mathbf{\theta}}) / \partial \boldsymbol{\mathbf{\theta}}^\top\)</span> is the matrix of derivatives with respect to the model parameters. However, in DWLS the full matrix is not used, so the asymptotic covariance should be corrected using a sandwich-type estimator as <span class="math display">\[\boldsymbol{\mathbf{H}} \boldsymbol{\mathbf{\Sigma}}_{\rho \rho} \boldsymbol{\mathbf{H}}^\top,\]</span> where <span class="math inline">\(\boldsymbol{\mathbf{H}} = (\boldsymbol{\mathbf{\Delta}}^\top \boldsymbol{\mathbf{W}} \boldsymbol{\mathbf{\Delta}})^{-1} \boldsymbol{\mathbf{\Delta}}^\top \boldsymbol{\mathbf{W}}\)</span>. This does not involve inversion of the full <span class="math inline">\(\boldsymbol{\mathbf{\Sigma}}_{\rho \rho}\)</span> matrix, so it’s computational less demanding. This is how the standard errors are obtained with the WLSM and the WLSMV estimators. In <code>lavaan</code>, this also corresponds to the <code>se = "robust.sem"</code> option (which is the default with WLSMV).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Derivatives</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>Delta <span class="ot">&lt;-</span> numDeriv<span class="sc">::</span><span class="fu">jacobian</span>(implied_cor, optim_lambdas<span class="sc">$</span>par)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># H Matrix</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">crossprod</span>(Delta <span class="sc">/</span> ase_rhos), <span class="fu">t</span>(Delta <span class="sc">/</span> ase_rhos<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Asymptotic covariance matrix based on the formula</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>H <span class="sc">%*%</span> acov_pcor <span class="sc">%*%</span> <span class="fu">t</span>(H)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;              [,1]          [,2]          [,3]
#&gt; [1,]  0.010358799 -0.0003888680 -0.0055221428
#&gt; [2,] -0.000388868  0.0059929608 -0.0001132114
#&gt; [3,] -0.005522143 -0.0001132114  0.0078359250</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to lavaan</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vcov</span>(onefactor_fit)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;               f=~x1         f=~x2         f=~x3
#&gt; f=~x1  0.0103593905 -0.0003890896 -0.0055224662
#&gt; f=~x2 -0.0003890896  0.0059928338 -0.0001129392
#&gt; f=~x3 -0.0055224662 -0.0001129392  0.0078359251</code></pre>
</div>
</div>
<p>So the results are essentially the same as in <code>lavaan</code>. The asymptotic standard errors can then be obtained as the square roots of the diagonal elements:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">diag</span>(H <span class="sc">%*%</span> acov_pcor <span class="sc">%*%</span> <span class="fu">t</span>(H)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.10177818 0.07741422 0.08852076</code></pre>
</div>
</div>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final thoughts</h2>
<p>So that’s what I have learned with the WLS estimators, and I felt like I finally got a better understanding of it. It reminds me things I have learned about the GLS estimator in the regression context (and I do wonder why it’s been called WLS in SEM given that in the context of regression, <a href="https://en.wikipedia.org/wiki/Weighted_least_squares">WLS generally refers to the use of a diagonal weight matrix</a>; perhaps that’s the reason we now use a diagonal weight matrix). There are things I may further explore, like doing it on the Theta parameterization instead of the Delta parameterization in this post, and dealing with the test statistics. But I will need to deal with the revision first.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Copyright 2023, Hok Chio (Mark) Lai</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>