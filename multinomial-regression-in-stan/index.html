---
title: Nominal Regression in STAN
author: marklai
date: '2022-07-30'
slug: multinomial-regression-in-stan
toc: true
categories:
  - Statistics
tags:
  - Bayesian
subtitle: ''
summary: ''
authors: []
lastmod: '2022-07-30T10:23:22-07:00'
featured: no
draft: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---


<div id="TOC">

</div>

<p>I was talking to a colleague about modeling nominal outcomes in STAN, and wrote up this example. Just put it here in case it’s helpful for anyone (probably myself in the future). This is based on <a href="https://psyc573-2022spring.netlify.app/glm2.html#nominal-logistic-regression">an example I made for a course</a>, where you can find the <code>brms</code> code for nominal regression. Please also check out the <a href="https://mc-stan.org/docs/stan-users-guide/multi-logit.html">Multi-logit regression session</a> on the Stan User’s guide.</p>
<div id="load-packages" class="section level2">
<h2>Load Packages</h2>
<pre class="r"><code>library(cmdstanr)
library(dplyr)
library(ggplot2)</code></pre>
<p>Check out this paper: <a href="https://journals.sagepub.com/doi/full/10.1177/2515245918823199" class="uri">https://journals.sagepub.com/doi/full/10.1177/2515245918823199</a></p>
<pre class="r"><code>stemcell &lt;- read.csv(&quot;https://osf.io/vxw73/download&quot;)</code></pre>
<pre class="r"><code>stemcell |&gt;
    ggplot(aes(x = rating)) +
    geom_bar() +
    facet_wrap(~ gender)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/plot-stemcell-1.png" width="672" /></p>
<p><a href="https://www.thearda.com/archive/files/Codebooks/GSS2006_CB.asp" class="uri">https://www.thearda.com/archive/files/Codebooks/GSS2006_CB.asp</a></p>
<p>The outcome is attitude towards stem cells research, and the predictor is gender.</p>
<blockquote>
<p>Recently, there has been controversy over whether the government should provide any funds at all for scientific research that uses stem cells taken from human embryos. Would you say the government . . .</p>
</blockquote>
<ul>
<li>1 = Definitely, should fund such research</li>
<li>2 = Probably should fund such research</li>
<li>3 = Probably should not fund such research</li>
<li>4 = Definitely should not fund such research</li>
</ul>
</div>
<div id="nominal-logistic-regression" class="section level2">
<h2>Nominal Logistic Regression</h2>
<p>Ordinal regression is a special case of nominal regression with the proportional odds assumption.</p>
</div>
<div id="model" class="section level2">
<h2>Model</h2>
<p><span class="math display">\[\begin{align}
  \text{rating}_i &amp; \sim \mathrm{Categorical}(\pi^1_{i}, \pi^2_{i}, \pi^3_{i}, \pi^4_{i})  \\
  \pi^1_{i} &amp; = \frac{1}{\exp(\eta^2_{i}) + \exp(\eta^3_{i}) + \exp(\eta^4_{i}) + 1}  \\
  \pi^2_{i} &amp; = \frac{\exp(\eta^2_{i})}{\exp(\eta^2_{i}) + \exp(\eta^3_{i}) + \exp(\eta^4_{i}) + 1}  \\
  \pi^3_{i} &amp; = \frac{\exp(\eta^3_{i})}{\exp(\eta^2_{i}) + \exp(\eta^3_{i}) + \exp(\eta^4_{i}) + 1}  \\
  \pi^4_{i} &amp; = \frac{\exp(\eta^4_{i})}{\exp(\eta^2_{i}) + \exp(\eta^3_{i}) + \exp(\eta^4_{i}) + 1}  \\
  \eta^2_{i} &amp; = \beta^2_{0} + \beta^2_{1} \text{male}_{i}  \\
  \eta^3_{i} &amp; = \beta^3_{0} + \beta^3_{1} \text{male}_{i} \\
  \eta^4_{i} &amp; = \beta^4_{0} + \beta^4_{1} \text{male}_{i} \\
\end{align}\]</span></p>
<pre class="r"><code>mod &lt;- cmdstan_model(&quot;nominal_reg.stan&quot;)
mod</code></pre>
<pre><code>## //
## // This Stan program defines a nominal regression model.
## //
## // It is based on
## //   https://mc-stan.org/docs/stan-users-guide/multi-logit.html
## //
## 
## // The input data is a vector &#39;y&#39; of length &#39;N&#39;.
## data {
##   int&lt;lower=0&gt; K;  // number of response categories
##   int&lt;lower=0&gt; N;  // number of observations (data rows)
##   int&lt;lower=0&gt; D;  // number of predictors
##   array[N] int&lt;lower=1, upper=K&gt; y;  // response vector
##   matrix[N, D] x;  // predictor matrix
## }
## 
## transformed data {
##   vector[D] zeros = rep_vector(0, D);
## }
## 
## // The parameters accepted by the model.
## parameters {
##   vector[K - 1] b0_raw;  // intercept for second to last categories
##   matrix[D, K - 1] beta_raw;
## }
## 
## // The model to be estimated.
## model {
##   // Add zeros for reference category
##   vector[K] b0 = append_row(0, b0_raw);
##   matrix[D, K] beta = append_col(zeros, beta_raw);
##   to_vector(beta_raw) ~ normal(0, 5);
##   y ~ categorical_logit_glm(x, b0, beta);
## }</code></pre>
<pre class="r"><code>stan_dat &lt;- with(stemcell,
     list(K = n_distinct(rating),
          N = length(rating),
          D = 1,
          y = rating,
          x = matrix(as.integer(gender == &quot;male&quot;)))
)</code></pre>
<pre class="r"><code># Draw samples
fit &lt;- mod$sample(data = stan_dat, seed = 123, chains = 4, 
                  parallel_chains = 2, refresh = 500,
                  iter_sampling = 2000, iter_warmup = 2000)</code></pre>
<pre class="r"><code>fit$summary() |&gt;
    knitr::kable()</code></pre>
<table>
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="8%" />
<col width="8%" />
<col width="11%" />
<col width="11%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">variable</th>
<th align="right">mean</th>
<th align="right">median</th>
<th align="right">sd</th>
<th align="right">mad</th>
<th align="right">q5</th>
<th align="right">q95</th>
<th align="right">rhat</th>
<th align="right">ess_bulk</th>
<th align="right">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">lp__</td>
<td align="right">-1035.3518437</td>
<td align="right">-1035.0200000</td>
<td align="right">1.7612849</td>
<td align="right">1.6160340</td>
<td align="right">-1038.6900000</td>
<td align="right">-1033.1300000</td>
<td align="right">1.000639</td>
<td align="right">3809.196</td>
<td align="right">4742.492</td>
</tr>
<tr class="even">
<td align="left">b0_raw[1]</td>
<td align="right">0.4703141</td>
<td align="right">0.4697820</td>
<td align="right">0.1118201</td>
<td align="right">0.1128904</td>
<td align="right">0.2877985</td>
<td align="right">0.6527007</td>
<td align="right">1.001230</td>
<td align="right">3667.338</td>
<td align="right">5286.149</td>
</tr>
<tr class="odd">
<td align="left">b0_raw[2]</td>
<td align="right">-0.6762280</td>
<td align="right">-0.6757360</td>
<td align="right">0.1507270</td>
<td align="right">0.1497626</td>
<td align="right">-0.9251864</td>
<td align="right">-0.4307565</td>
<td align="right">1.000439</td>
<td align="right">4465.972</td>
<td align="right">5274.345</td>
</tr>
<tr class="even">
<td align="left">b0_raw[3]</td>
<td align="right">-0.9675208</td>
<td align="right">-0.9653220</td>
<td align="right">0.1672082</td>
<td align="right">0.1658889</td>
<td align="right">-1.2447755</td>
<td align="right">-0.6988120</td>
<td align="right">1.001632</td>
<td align="right">4428.634</td>
<td align="right">5072.438</td>
</tr>
<tr class="odd">
<td align="left">beta_raw[1,1]</td>
<td align="right">-0.1760178</td>
<td align="right">-0.1774040</td>
<td align="right">0.1680554</td>
<td align="right">0.1646985</td>
<td align="right">-0.4533714</td>
<td align="right">0.1036652</td>
<td align="right">1.000391</td>
<td align="right">3881.178</td>
<td align="right">5200.826</td>
</tr>
<tr class="even">
<td align="left">beta_raw[1,2]</td>
<td align="right">-0.0121064</td>
<td align="right">-0.0135833</td>
<td align="right">0.2209685</td>
<td align="right">0.2195530</td>
<td align="right">-0.3762467</td>
<td align="right">0.3532682</td>
<td align="right">1.000601</td>
<td align="right">4376.717</td>
<td align="right">5480.247</td>
</tr>
<tr class="odd">
<td align="left">beta_raw[1,3]</td>
<td align="right">-0.1751981</td>
<td align="right">-0.1765975</td>
<td align="right">0.2540991</td>
<td align="right">0.2564196</td>
<td align="right">-0.5939876</td>
<td align="right">0.2370495</td>
<td align="right">1.001283</td>
<td align="right">4382.617</td>
<td align="right">5279.069</td>
</tr>
</tbody>
</table>
<p>Compare to <code>brms</code>:</p>
<pre class="r"><code>library(brms)
brm(rating ~ gender, data = stemcell, family = categorical(link = &quot;logit&quot;),
    file = &quot;mlogit&quot;)</code></pre>
<pre><code>##  Family: categorical 
##   Links: mu2 = logit; mu3 = logit; mu4 = logit 
## Formula: rating ~ gender 
##    Data: stemcell (Number of observations: 829) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## mu2_Intercept      0.47      0.11     0.26     0.69 1.00     3990     3108
## mu3_Intercept     -0.67      0.15    -0.97    -0.39 1.00     3809     3130
## mu4_Intercept     -0.96      0.17    -1.29    -0.63 1.00     4027     3031
## mu2_gendermale    -0.18      0.17    -0.51     0.15 1.00     4272     2829
## mu3_gendermale    -0.01      0.22    -0.43     0.41 1.00     4141     2902
## mu4_gendermale    -0.17      0.25    -0.67     0.34 1.00     3922     2937
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>The estimates are pretty much the same.</p>
</div>
